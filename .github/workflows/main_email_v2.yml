name: Filter RSS Feed everyday + Email everyday morning + Email when error

on:
  schedule:
    # ì˜¤ì „ 8ì‹œ CDT = 13:00 UTC + 17ë¶„
    - cron: '17 13 * * *'
    # 7PM Texas (CDT) = 00:00 UTC (technically next day midnight, but cron remains the same) + 17 min
    - cron: '17 0 * * *'
  workflow_dispatch:
  
jobs:
  filter-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # â¡ï¸ last_failed_journal.txt ë³µì› â†’ artifact ì‚¬ìš©
      # Restore last failed journal artifact for resuming
      - name: Download last failed journal artifact
        id: artifact-restore
        uses: actions/download-artifact@v4
        with:
          name: last_failed_journal
          path: ./last_failed_journal_work.txt
        continue-on-error: true  # artifact ì—†ìœ¼ë©´ ìƒˆë¡œ ì‹œì‘

      # â¡ï¸ ì‘ì—…ìš© íŒŒì¼ë¡œ ë³µì‚¬í•˜ì—¬ ì¶©ëŒ ë°©ì§€
      # Copy to a working file for Python script
      - name: Prepare working state file
        run: |
          if [ -f last_failed_journal_work.txt ]; then
            cp last_failed_journal_work.txt last_failed_journal.txt
          else
            touch last_failed_journal.txt
          fi

      - name: Set up Python with caching
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Python script to filter RSS and create files
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          # ğŸš¨ GitHub Actions ì‹¤í–‰ ë§í¬ í™˜ê²½ ë³€ìˆ˜ ì¶”ê°€
          # Add GitHub Actions run URL to environment variables
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          python filter_rss_v4.py
      
      # â¡ï¸ RSS í•„í„°ë§ ê²°ê³¼ artifact ì—…ë¡œë“œ
      # Upload artifacts for next steps
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: filtered-files
          path: |
            filtered_titles.txt
            filtered_feed_*.xml
      
      # â¡ï¸ last_failed_journal.txt ì €ì¥ â†’ artifact ì‚¬ìš©
      # Save last failed journal state as artifact
      - name: Upload last failed journal artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: last_failed_journal
          path: ./last_failed_journal.txt

      # â¡ï¸ GitHub Pages ë°°í¬
      - name: Deploy to GitHub Pages
        if: success() # ì„±ê³µí–ˆì„ ë•Œë§Œ ë°°í¬
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          publish_branch: gh-pages

      # â¡ï¸ filtered-files artifact ë‹¤ìš´ë¡œë“œ
      - name: Download artifacts
        if: success()
        uses: actions/download-artifact@v4
        with:
          name: filtered-files

      # â¡ï¸ UTC ì‹œê° ê°€ì ¸ì˜¤ê¸°
      - name: Get UTC hour
        id: get_hour
        run: echo "hour=$(date -u +%H)" >> $GITHUB_OUTPUT

      # â¡ï¸ ì´ë©”ì¼ ë°œì†¡ (ë§¤ì¼ ì•„ì¹¨)
      - name: Send email with results
        if: success() && steps.get_hour.outputs.hour > '10'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: '[hoonica RSS] New Paper Updates'
          to: ${{ secrets.MAIL_TO }}
          from: ${{ secrets.MAIL_FROM }}
          body: file://filtered_titles.txt

  # â¡ï¸ ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ì´ë©”ì¼ ì•Œë¦¼ì„ ìœ„í•œ ë³„ë„ Job
  # Separate job to send email notification immediately on failure
  failure-notification:
    runs-on: ubuntu-latest
    needs: filter-and-deploy
    if: ${{ always() && needs.filter-and-deploy.result == 'failure' }}

    steps:
      # â¡ï¸ filtered-files artifact ë‹¤ìš´ë¡œë“œ
      - name: Download error log artifact
        uses: actions/download-artifact@v4
        with:
          name: filtered-files

      # â¡ï¸ ì˜¤ë¥˜ ì´ë©”ì¼ ë°œì†¡
      - name: Send email with error report
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: '[NatSci RSS] Action Failed!'
          to: ${{ secrets.MAIL_TO }}
          from: ${{ secrets.MAIL_FROM }}
          body: file://filtered_titles.txt
