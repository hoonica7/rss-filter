name: Filter RSS Feed everyday + Email on Saturday + Email when error

on:
  schedule:
    # ë§¤ì¼ íœ´ìŠ¤í„´ ì‹œê°„ ì˜¤ì „ 8ì‹œ(CDT)ì— ì‹¤í–‰ -> UTC ê¸°ì¤€ 13ì‹œ
    - cron: '0 13 * * *'
  workflow_dispatch:

jobs:
  filter-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # â¡ï¸ last_failed_journal.txt ìºì‹œ ë³µì›
      # íŒŒì¼ ë‚´ìš©ì˜ í•´ì‹œê°’ì„ ì‚¬ìš©í•˜ì—¬ ìºì‹œ í‚¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
      # ì´ë ‡ê²Œ í•˜ë©´ íŒŒì¼ ë‚´ìš©ì´ ë°”ë€Œì—ˆì„ ë•Œë§Œ ìƒˆë¡œìš´ ìºì‹œë¥¼ ë³µì›í•©ë‹ˆë‹¤.
      - name: Restore last failed journal state
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: last_failed_journal.txt
          # í‚¤ë¥¼ ê³ ìœ í•˜ê²Œ ë§Œë“¤ì–´ ì¶©ëŒì„ ë°©ì§€í•˜ê³ , íŒŒì¼ ë‚´ìš©ì´ ë³€ê²½ë  ë•Œë§Œ ìºì‹œë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.
          key: ${{ runner.os }}-last-failed-journal-${{ hashFiles('last_failed_journal.txt') }}
          # ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” í‚¤ê°€ ì—†ì„ ê²½ìš°, ì´ í‚¤ë¡œ ì‹œì‘í•˜ëŠ” ê°€ì¥ ìµœê·¼ì˜ ìºì‹œë¥¼ ë³µì›í•©ë‹ˆë‹¤.
          restore-keys: |
            ${{ runner.os }}-last-failed-journal-

      - name: Set up Python with caching
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Python script to filter RSS and create files
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          # ğŸš¨ GitHub Actions ì‹¤í–‰ ë§í¬ í™˜ê²½ ë³€ìˆ˜ ì¶”ê°€
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          python filter_rss_v3_NatSci.py
      
      - name: Upload artifacts for next steps
        uses: actions/upload-artifact@v4
        with:
          name: filtered-files
          path: |
            filtered_titles.txt
            filtered_feed_*.xml
      
      # â¡ï¸ last_failed_journal.txt ìºì‹œ ì €ì¥
      # ì´ì „ ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•œ í‚¤ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì—¬ ìºì‹œë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
      # restore-keys ì†ì„±ì€ ì´ ë‹¨ê³„ì—ì„œ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
      - name: Cache last_failed_journal state
        uses: actions/cache/save@v4
        if: always()
        with:
          path: last_failed_journal.txt
          # ë³µì› ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•œ ê²ƒê³¼ ë™ì¼í•œ í‚¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
          key: ${{ runner.os }}-last-failed-journal-${{ hashFiles('last_failed_journal.txt') }}

      - name: Deploy to GitHub Pages
        if: success() # ì„±ê³µí–ˆì„ ë•Œë§Œ ë°°í¬
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          publish_branch: gh-pages

      - name: Download artifacts
        if: success()
        uses: actions/download-artifact@v4
        with:
          name: filtered-files
      
      # ì´ë©”ì¼ ë°œì†¡ ì—¬ë¶€ë¥¼ ê²°ì •í•˜ëŠ” ìŠ¤í… (ì„±ê³µ ì‹œ)
      - name: Check if today is Saturday
        if: success()
        id: check_day
        run: echo "is_saturday=$(date +%u)" >> $GITHUB_OUTPUT
      
      - name: Send email with results
        # ì˜¤ëŠ˜ì´ í† ìš”ì¼ì¸ ê²½ìš°(date +%u == 6)ì—ë§Œ ì´ë©”ì¼ì„ ë°œì†¡í•©ë‹ˆë‹¤.
        if: success() && steps.check_day.outputs.is_saturday == '6'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: '[NatSci RSS] New Paper Updates'
          to: ${{ secrets.MAIL_TO }}
          from: ${{ secrets.MAIL_FROM }}
          body: file://filtered_titles.txt

  # ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ì´ë©”ì¼ ì•Œë¦¼ì„ ìœ„í•œ ë³„ë„ Job
  failure-notification:
    runs-on: ubuntu-latest
    needs: filter-and-deploy
    if: failure()

    steps:
      - name: Download error log artifact
        uses: actions/download-artifact@v4
        with:
          name: filtered-files

      - name: Send email with error report
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: '[NatSci RSS] Action Failed!'
          to: ${{ secrets.MAIL_TO }}
          from: ${{ secrets.MAIL_FROM }}
          body: file://filtered_titles.txt
